/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/documentation/sdk/controller/SampleBaseController","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/core/Component","sap/ui/core/ComponentContainer","sap/ui/documentation/sdk/controller/util/ControlsInfo","sap/ui/documentation/sdk/util/ToggleFullScreenHandler","sap/m/BusyDialog","sap/m/Text","sap/ui/core/HTML","sap/m/library","sap/base/Log","sap/base/util/UriParameters","sap/ui/core/Fragment","sap/ui/documentation/sdk/util/Resources","./config/sampleForwardingConfig","sap/base/strings/capitalize"],function(S,J,R,C,a,b,T,B,c,H,m,L,U,F,d,s,e){"use strict";var f=m.URLHelper;var A=["sap-ui-rtl","sap-ui-language"];return S.extend("sap.ui.documentation.sdk.controller.Sample",{onInit:function(){var o=sap.ui.getCore().getConfiguration();S.prototype.onInit.call(this);this.getRouter().getRoute("sample").attachPatternMatched(this._onSampleMatched,this);this.oModel=new J({showNavButton:true,showNewTab:false,rtaLoaded:false,density:this.getOwnerComponent().getContentDensityClass(),rtl:o.getRTL(),theme:o.getTheme()});this._sId=null;this._sEntityId=null;this.router=this.getRouter();this.getView().setModel(this.oModel);this.bus=sap.ui.getCore().getEventBus();this.setDefaultSampleTheme();this.bus.subscribe("themeChanged","onDemoKitThemeChanged",this.onDemoKitThemeChanged,this);this.getOwnerComponent()._sSampleIframeOrigin=d.getConfig()!=="."?d.getConfig():window.origin;},_onSampleMatched:function(g){this._sId=g.getParameter("arguments").sampleId;this._sEntityId=g.getParameter("arguments").entityId;this.byId("page").setBusy(true);if(s[this._sId]){return this.router.navTo("sample",{entityId:s[this._sId].entityId,sampleId:s[this._sId].sampleId},true);}this.getModel("appView").setProperty("/bHasMaster",false);b.loadData().then(this._loadSample.bind(this));},_loadSample:function(D){var p=this.byId("page"),M=this.oModel.getData(),o=D.samples[this._sId],g;if(!o){setTimeout(function(){p.setBusy(false);},0);this.onRouteNotFound();return;}this.entityId=this._sEntityId?this._sEntityId:o.entityId;M.sEntityId=this.entityId;if(o.previousSampleId||o.nextSampleId){M.previousSampleId=o.previousSampleId;M.nextSampleId=o.nextSampleId;}if(o.contexts){g=o.contexts[this.entityId];if(g){M.previousSampleId=g.previousSampleId;M.nextSampleId=g.nextSampleId;}else{this.onRouteNotFound();return;}}M.title="Sample: "+o.name;M.showNewTab=true;M.id=o.id;M.name=o.name;M.details=o.details;M.description=o.description;M.showSettings=true;this._createIframe().then(function(h){this.getOwnerComponent()._oCurrentOpenedSample=this._oHtmlControl;if(h){M.stretch=h.stretch;M.includeInDownload=h.additionalDownloadFiles;if(h.files){var r=sap.ui.require.toUrl((o.id).replace(/\./g,"/"));M.files=[];for(var i=0;i<h.files.length;i++){var j=h.files[i];M.files.push({name:j});this._updateFileContent(r,j);}}M.iframe=h.iframe;p.setProperty("enableScrolling",!!h.stretch,true);}this.getAPIReferenceCheckPromise(o.entityId).then(function(k){this.getView().byId("apiRefButton").setVisible(k);}.bind(this));this.oModel.setData(M);this.appendPageTitle(this.getModel().getProperty("/name"));}.bind(this)).catch(function(E){p.removeAllContent();p.addContent(new c({text:"Error while loading the sample: "+E}));}).finally(function(){setTimeout(function(){p.setBusy(false);},0);});},handleSettings:function(){if(!this._oMessageBundle){this._oMessageBundle=new R({bundleName:"sap.ui.documentation.messagebundle"});}if(!this._oSettingsDialog){this._oSettingsDialog=sap.ui.xmlfragment("sample","sap.ui.documentation.sdk.view.appSettingsDialog",this);this._oSettingsDialog.setModel(this._oMessageBundle,"i18n");}this.loadSampleSettings(this.applySampleSettings.bind(this)).then(function(){this._oSettingsDialog.open();}.bind(this)).catch(function(g){L.error(g);});},applySampleSettings:function(g){if(g.data.type==="SETTINGS"){var t=sap.ui.getCore().byId("sample--ThemeSelect");t.setSelectedKey(g.data.data.theme);sap.ui.getCore().byId("sample--RTLSwitch").setState(g.data.data.RTL);sap.ui.getCore().byId("sample--DensityModeSwitch").setSelectedKey(this._presetDensity(g.data.data.density,true));}},loadSampleSettings:function(g){return new Promise(function(r,h){var i=this._oHtmlControl.getDomRef();i.contentWindow.postMessage({type:"SETTINGS",reason:"get"},this.getOwnerComponent()._sSampleIframeOrigin);window.addEventListener("message",l);function l(j){g(j);window.removeEventListener("message",l);r();}setTimeout(function(){h("The sample iframe is not loading settings");},3000);}.bind(this));},handleCloseAppSettings:function(){this._oSettingsDialog.close();},handleSaveAppSettings:function(){var D=sap.ui.getCore().byId("sample--DensityModeSwitch").getSelectedKey(),t=sap.ui.getCore().byId("sample--ThemeSelect").getSelectedKey(),r=sap.ui.getCore().byId("sample--RTLSwitch").getState();this._oSettingsDialog.close();if(!this._oBusyDialog){this._oBusyDialog=new B();this._handleBusyDialog();}else{this._handleBusyDialog();}this._applyAppConfiguration(t,D,r);this._saveLocalSettings(t,D,r);},_saveLocalSettings:function(t,D,r){var D=this._presetDensity(D);this.getView().getModel().setData({theme:t,rtl:r,density:D},true);},_presetDensity:function(D,t){return t?D.slice(9).toLowerCase():"sapUiSize"+e(D);},_applyAppConfiguration:function(t,D,r){var i=this._oHtmlControl.getDomRef(),D=this._presetDensity(D);i.contentWindow.postMessage({type:"SETTINGS",reason:"set",data:{"density":D,"RTL":r,"theme":t}},this.getOwnerComponent()._sSampleIframeOrigin);},_handleBusyDialog:function(){this._oBusyDialog.open();setTimeout(function(){this._oBusyDialog.close();}.bind(this),1000);},_updateFileContent:function(r,g){this.fetchSourceFile(r+"/"+g).then(function(v){var h=this.oModel.getProperty("/files");h.some(function(o){if(o.name===g){o.raw=v;return true;}});this.oModel.setProperty("/files",h);}.bind(this));},onAPIRefPress:function(){this.getRouter().navTo("apiId",{id:this.entityId});},onNewTab:function(){this.loadSampleSettings(function(g){this._applySearchParamValueToIframeURL('sap-ui-theme',g.data.data.theme);this._applySearchParamValueToIframeURL('sap-ui-rtl',g.data.data.RTL);this._applySearchParamValueToIframeURL('sap-ui-density',g.data.data.density);}.bind(this)).then(function(){f.redirect(this.sIFrameUrl,true);}.bind(this));},onPreviousSample:function(E){this.getRouter().navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/previousSampleId")});},onNextSample:function(E){this.getRouter().navTo("sample",{entityId:this.entityId,sampleId:this.oModel.getProperty("/nextSampleId")});},onInfoSample:function(E){var o=E.getSource();if(!this._oPopover){F.load({name:"sap.ui.documentation.sdk.view.samplesInfo",controller:this}).then(function(p){this.getView().addDependent(p);this._oPopover=p;this._oPopover.openBy(o);}.bind(this));}else{this._oPopover.openBy(o);}},_resolveIframePath:function(g,I){var h=I.split("/"),i;for(i=0;i<h.length-1;i++){if(h[i]==".."){g=g.substring(0,g.lastIndexOf("."));}else{g+="."+h[i];}}return g;},_createIframe:function(){return new Promise(function(r,g){var h=this._sId,i="",j=/\/([^\/]*)$/,k=/\..+$/,l,n,o,I;this.fResolve=r;this.fReject=g;var p=(window['sap-ui-documentation-config']&&window['sap-ui-documentation-config'].demoKitResourceOrigin)||"",q=d.getResourcesVersion(),t="";A.forEach(function(P,u){if(new URL(document.location.href).searchParams.get(P)){t+=(t===""?"?":"&")+P+"="+new URL(document.location.href).searchParams.get(P);}});t=(t===""?"?":t+"&")+"sap-ui-xx-sample-id="+h+"&sap-ui-xx-sample-origin="+p+q+"&sap-ui-xx-dk-origin="+window.location.origin;this.sIFrameUrl=d.getResourceOrigin()+"/resources/sap/ui/documentation/sdk/index.html"+t;if(this._oHtmlControl){this._oHtmlControl.destroy();}var M=function(u){var v=this.getView().getModel().getData();if(u.data.type==="INIT"){if(u.data.config&&u.data.config.sample&&u.data.config.sample.iframe){h=this._sId;I=u.data.config.sample.iframe;i=this._resolveIframePath(h,I);l=j.exec(I);n=(l&&l.length>1?l[1]:I);o=k.exec(n)[0];var w=n.replace(k,"");this.sIFrameUrl=(sap.ui.require.toUrl((i+"/"+w).replace(/\./g,"/"))+o||".html")+"?sap-ui-theme="+sap.ui.getCore().getConfiguration().getTheme();this._oHtmlControl.getDomRef().src=this.sIFrameUrl;}this._oHtmlControl.getDomRef().contentWindow.postMessage({type:"SETTINGS",reason:"set",data:{"density":v.density,"RTL":v.rtl,"theme":v.theme}},this.getOwnerComponent()._sSampleIframeOrigin);this.fResolve(u.data.config.sample);}else if(u.data.type==="ERR"){this.fReject(u.data.data.msg);}else if(u.data.type==="RTA"){this._loadRTA.call(this);}}.bind(this);this._oHtmlControl=new H({id:"sampleFrame",content:'<iframe src="'+this.sIFrameUrl+'" id="sampleFrame" frameBorder="0"></iframe>'}).addEventDelegate({onBeforeRendering:function(){window.removeEventListener("message",M);}}).addEventDelegate({onAfterRendering:function(){window.addEventListener("message",M);}});this.byId("page").removeAllContent();this.byId("page").addContent(this._oHtmlControl);}.bind(this));},_createComponent:function(){var g='sampleComp-'+this._sId;var h=this._sId;var M=this.getOwnerComponent();var o=C.get(g);if(o){o.destroy();}return M.runAsOwner(function(){return C.create({id:g,name:h}).then(function(i){return new a({component:i});});});},setDefaultSampleTheme:function(){var g=d.getResourcesVersion();this._sDefaultSampleTheme=g&&parseInt(g.slice(3,5))<68?"sap_belize":sap.ui.getCore().getConfiguration().getTheme();},onDemoKitThemeChanged:function(g,E,D){if(this._oHtmlControl&&this.getModel().getProperty("/iframe")){this._applySearchParamValueToIframeURL("sap-ui-theme",D.sThemeActive);this._oHtmlControl.getDomRef().src=this.sIFrameUrl;}},onNavBack:function(E){this.getRouter().navTo("entity",{id:this.entityId});},onNavToCode:function(g){this.getRouter().navTo("code",{entityId:this.entityId,sampleId:this._sId},false);},onToggleFullScreen:function(E){T.updateMode(E,this.getView(),this);},_oRTA:null,_applySearchParamValueToIframeURL:function(g,n){var h=window.URL,i;try{i=new h(this.sIFrameUrl,document.location);}catch(j){L.warning("window.URL is not supported. The search param value won't be applied.");return;}this.sIFrameUrl=this.sIFrameUrl.replace(i.search,"");i.searchParams.set(g,n);this.sIFrameUrl=this.sIFrameUrl+decodeURI(i.search);},_loadRTA:function(){var M=this.oModel.getData();M.rtaLoaded=true;this.oModel.setData(M);this.getRouter().attachRouteMatched(function(){if(this._oRTA){this._oRTA.destroy();this._oRTA=null;}},this);},onToggleAdaptationMode:function(E){if(!this._oHtmlControl||!this._oHtmlControl.getDomRef()){return false;}var i=this._oHtmlControl.getDomRef();i.contentWindow.postMessage({type:"RTA",data:{"msg":"Start the RTA"}},this.getOwnerComponent()._sSampleIframeOrigin);},onRouteNotFound:function(){var n=this.getModel("i18n").getProperty("NOT_FOUND_SAMPLE_TITLE");this.getRouter().myNavToWithoutHash("sap.ui.documentation.sdk.view.SampleNotFound","XML",false);setTimeout(this.appendPageTitle.bind(this,n));return;}});});
