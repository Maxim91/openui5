/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/documentation/sdk/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/CustomData","sap/ui/documentation/sdk/controller/util/APIInfo","sap/ui/documentation/sdk/model/formatter","sap/ui/core/mvc/XMLView","sap/base/Log"],function(B,J,C,A,f,X,L){"use strict";return B.extend("sap.ui.documentation.sdk.controller.ApiDetail",{NOT_AVAILABLE:'N/A',NOT_FOUND:'Not found',onInit:function(){this.getRouter().getRoute("apiSpecialRoute").attachPatternMatched(this._onTopicMatched,this);this._oModel=new J();this._oModel.setSizeLimit(10000);this._oContainerPage=this.getView().byId("apiDetailPageContainer");},_onTopicMatched:function(e){var a,c,o;a=this.getRouter()._decodeSpecialRouteArguments(e);c=this.getOwnerComponent();if(this._sTopicid===a.id){o=this._oView&&this._oView.getController();if(o){o.scrollToEntity(a.entityType,a.entityId);}return;}this._sTopicid=a.id;this._sEntityType=a.entityType;this._sEntityId=a.entityId;if(this._oView&&!this._oView.bIsDestroyed){this._oView.destroy();this._oContainerPage.setBusy(true);}c.loadVersionInfo().then(function(){this._aAllowedMembers=this.getModel("versionData").getProperty("/allowedMembers");}.bind(this)).then(A.getIndexJsonPromise).then(this._processApiIndexAndLoadApiJson.bind(this)).then(this._findEntityInApiJsonData.bind(this)).then(this._addMissingNodesToControlData.bind(this)).then(this._buildBorrowedModel.bind(this)).then(this._createModelAndSubView.bind(this)).then(this._initSubView.bind(this)).catch(function(r){if(r===this.NOT_FOUND){this._oContainerPage.setBusy(false);this.onRouteNotFound();}else if(typeof r==="string"){L.error(r);}else if(r.name){L.error(r.name,r.message);}else if(r.message){L.error(r.message);}}.bind(this));},_initSubView:function(v){var c=v.getController();if(v.data("topicid")!==this._sTopicid){v.destroy();return;}this._oView=v;this._oContainerPage.addContent(v);this._oContainerPage.setBusy(false);c.initiate({sTopicId:this._sTopicid,oModel:this._oModel,aApiIndex:this._aApiIndex,aAllowedMembers:this._aAllowedMembers,oEntityData:this._oEntityData,sEntityType:this._sEntityType,sEntityId:this._sEntityId,oOwnerComponent:this.getOwnerComponent(),oContainerView:this.getView(),oContainerController:this});},_createModelAndSubView:function(b){this._oControlData.borrowed=b;this._bindData(this._sTopicid);return X.create({height:"100%",customData:new C({key:"topicid",value:this._sTopicid}),viewName:"sap.ui.documentation.sdk.view.SubApiDetail",async:true,preprocessors:{xml:{models:{data:this._oModel}}}});},_buildBorrowedModel:function(c){this._oControlData=c;return this.buildBorrowedModel(c);},_addMissingNodesToControlData:function(c){var l,n,N,s,e;if(this._oEntityData.kind==="namespace"){e=Array.isArray(this._oEntityData.nodes)&&this._oEntityData.nodes;l=Array.isArray(c.nodes)&&c.nodes;if(e&&l&&e.length>l.length){l.sort(this._compareStringsCaseInsensitive);e.forEach(function(o,i){n=o.name;s=l[i]&&l[i].name;if(n!==s){N={};N.name=n;N.description="";N.href="api/"+n;if(o.deprecated){N.deprecated=true;}l.splice(i,0,N);}});}}return c;},_compareStringsCaseInsensitive:function(a,b){var l=a.name.toLowerCase(),c=b.name.toLowerCase();if(l<c){return-1;}if(l>c){return 1;}return 0;},_filterEntityByVisibilityInApiJsonData:function(l){var v=this.getModel("versionData"),i=v.getProperty("/isInternal");if(!i){l=(l||[]).filter(function(n){return!n.hasOwnProperty('visibility')||n.visibility!=='restricted';});}return l;},_findEntityInApiJsonData:function(l){var o,a,i;for(i=0,a=l.length;i<a;i++){o=l[i];if(o.name===this._sTopicid){if(o.visibility===undefined||this._aAllowedMembers.indexOf(o.visibility)>=0){return o;}else{return Promise.reject(this.NOT_FOUND);}}}return Promise.reject(this.NOT_FOUND);},_processApiIndexAndLoadApiJson:function(d){var e,m,t=this._sTopicid;this._aApiIndex=d;function b(a){return a.some(function(o){var F=o.name===t;if(!F&&o.nodes){return b(o.nodes);}else if(F){e=o;return true;}return false;});}b(d);if(e){this._oEntityData=e;if(e.deprecated||e.bAllContentDeprecated){m=this.getOwnerComponent().getConfigUtil().getMasterView("apiId").getController();m.selectDeprecatedSymbol(this._sTopicid);}e.nodes=this._filterEntityByVisibilityInApiJsonData(e.nodes);return A.getLibraryElementsJSONPromise(e.lib).then(function(d){return Promise.resolve(d);});}return Promise.reject(this.NOT_FOUND);},_bindData:function(t){var c=this._oControlData,m,u,s=function(a,b){a=a.toLowerCase();b=b.toLowerCase();if(a>b){return 1;}else if(a<b){return-1;}return 0;};u=c['ui5-metadata'];c.hasProperties=false;c.hasOwnMethods=false;c.hasControlProperties=false;c.hasAssociations=false;c.hasAggregations=false;c.hasSpecialSettings=false;c.hasAnnotations=false;var i=function(e){return(this._aAllowedMembers.indexOf(e.visibility)>=0);}.bind(this);var F=function(e){e.name&&(e.name=f.apiRefEntityName(e.name));e.code&&(e.code=f.apiRefEntityName(e.code));if(e.name){var p=e.name.replace(/[$#/]/g,".");e.placeholderId=p+"_method";e.subPlaceholderId=p+"__method";}return e;};if(c.borrowed.properties.length){u=u||(c['ui5-metadata']={});u.properties=(u.properties||[]).concat(c.borrowed.properties);}if(c.borrowed.aggregations.length){u=u||(c['ui5-metadata']={});u.aggregations=(u.aggregations||[]).concat(c.borrowed.aggregations);}if(c.borrowed.associations.length){u=u||(c['ui5-metadata']={});u.associations=(u.associations||[]).concat(c.borrowed.associations);}if(c.properties){c.properties=this.transformElements(c.properties,i,F);c.hasProperties=!!c.properties.length;}if(c.methods){c.methods=this.transformElements(c.methods,i,F);c.hasOwnMethods=!!c.methods.length;}if(u){c.dnd=u.dnd;c.hasControlProperties=!!(u.properties&&u.properties.length);c.hasAssociations=!!(u.associations&&u.associations.length);c.hasAggregations=!!(u.aggregations&&u.aggregations.length);c.hasSpecialSettings=!!(u.specialSettings&&u.specialSettings.length);c.hasAnnotations=!!(u.annotations&&u.annotations.length);if(c.hasControlProperties){u.properties=this.transformElements(u.properties,i).sort(function(a,b){return s(a.name,b.name);});}if(c.hasAssociations){u.associations=this.transformElements(u.associations,i).sort(function(a,b){return s(a.name,b.name);});}if(c.hasAggregations){u.aggregations=this.transformElements(u.aggregations,i).sort(function(a,b){return s(a.name,b.name);});c.hasAggregationAltTypes=u.aggregations.some(function(e){return!!e.altTypes;});}if(c.hasSpecialSettings){u.specialSettings=this.transformElements(u.specialSettings,i).sort(function(a,b){return s(a.name,b.name);});}if(c.hasAnnotations){u.annotations=(u.annotations).sort(function(a,b){return s(a.annotation,b.annotation);});}}c.nodes=this.transformElements(c.nodes||[],i).sort(function(a,b){return s(a.name,b.name);});c.hasChildren=c.nodes&&!!c.nodes.length;c.hasConstructor=c.hasOwnProperty("constructor")&&!!c.constructor;c.hasOwnEvents=!!c.events;c.hasEvents=!!(c.hasOwnEvents||(c.borrowed&&c.borrowed.events.length>0));c.hasMethods=!!(c.hasOwnMethods||(c.borrowed&&c.borrowed.methods.length>0));if(c.implements&&c.implements.length){c.implementsParsed=c.implements.map(function(a,b,d){var D=a.split("."),e=D[D.length-1];return{href:a,name:e};});c.hasImplementsData=true;}else{c.hasImplementsData=false;}c.isFunction=c.kind==="function";c.isClass=c.kind==="class";c.isNamespace=c.kind==="namespace";c.isDerived=!!c.extends;c.extendsText=c.extends||this.NOT_AVAILABLE;c.sinceText=c.since||this.NOT_AVAILABLE;c.module=c.module||this.NOT_AVAILABLE;this._oModel.setData(c);if(this.extHookbindData){this.extHookbindData(t,m);}},buildBorrowedModel:function(c){var b,d,e,g,h,s,j,m,M,p,P,k,l,n,q,I,r=[],S;if(!c){return Promise.resolve({events:[],methods:[],properties:[],aggregations:[],associations:[]});}j={methods:[],events:[],properties:[],aggregations:[],associations:[]};s=c.extends;var v=function(i){return this._aAllowedMembers.indexOf(i.visibility)!==-1;}.bind(this);m=c.methods||[];M=m.map(function(o){return o.name;});p=c["ui5-metadata"]&&c["ui5-metadata"].properties||[];P=p.map(function(o){return o.name;});k=c["ui5-metadata"]&&c["ui5-metadata"].aggregations||[];l=k.map(function(a){return a.name;});n=c["ui5-metadata"]&&c["ui5-metadata"].associations||[];q=n.map(function(a){return a.name;});var O=function(i){return M.indexOf(i.name)===-1;};var t=function(i){return P.indexOf(i.name)===-1&&!i.borrowedFrom&&!j.properties.some(function(o){return o.name===i.name;});};var u=function(i){return l.indexOf(i.name)===-1&&!i.borrowedFrom;};var w=function(i){return q.indexOf(i.name)===-1&&!i.borrowedFrom;};function x(a,T){S=null;return a.some(function(o){var F=o.name===T;if(!F&&o.nodes){return x(o.nodes,T);}else if(F){S=o;return true;}return false;});}I=[s];while(s){x(this._aApiIndex,s);if(S){s=S.extends;if(s){I.push(s);}if(r.indexOf(S.lib)===-1){r.push(S.lib);}}else{s=false;break;}}var y=r.map(function(a){return A.getLibraryElementsJSONPromise(a);});return Promise.all(y).then(function(R){var a=[],o;R.forEach(function(i){a=a.concat(i);});I.forEach(function(s){var z,i=a.length;while(i--){if(a[i].name===s){z=a[i];break;}}var D=function(G){return{name:G.name,link:"api/"+s+"#methods/"+G.name};};var E=function(G){return{name:G.name,link:"api/"+s+"#events/"+G.name};};var F=function(G){return Object.assign({},G,{borrowedFrom:s});};if(z){o=z["ui5-metadata"]||[];if(c["ui5-metadata"]&&!c["ui5-metadata"].defaultAggregation&&o.defaultAggregation){c["ui5-metadata"].defaultAggregation=o.defaultAggregation;}b=(z.methods||[]).filter(v).filter(O).map(D);if(b.length){j.methods.push({name:s,methods:b});}d=(z.events||[]).filter(v).map(E);if(d.length){j.events.push({name:s,events:d});}e=(o.properties||[]).filter(v).filter(t).map(F);if(e.length){j.properties=j.properties.concat(e);}g=(o.aggregations||[]).filter(v).filter(u).map(F);if(g.length){j.aggregations=j.aggregations.concat(g);}h=(o.associations||[]).filter(v).filter(w).map(F);if(h.length){j.associations=j.associations.concat(h);}}});return j;});},transformElements:function(e,F,a){var i,l=e.length,n=[],E;for(i=0;i<l;i++){E=e[i];if(F&&!F(E)){continue;}if(a){a(E);}n.push(E);}return n;}});});
